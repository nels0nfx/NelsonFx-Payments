<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - NelsonFx</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Style & Script -->
  <link rel="stylesheet" href="admin-style.css" />
  <script src="admin-script.js" defer></script>
</head>
<body>

  <!-- Loading Spinner -->
  <div id="spinner">
    <div class="loader"></div>
  </div>

  <!-- Toast Notification -->
  <div id="toast-container"></div>

  <div class="admin-container">
    <h1>Admin Panel - NelsonFx</h1>
    <button onclick="logout()">Logout</button>

    <div class="menu">
      <button onclick="showSection('dashboard')">Dashboard</button>
      <button onclick="showSection('payments')">Manage Payments</button>
      <button onclick="showSection('chat-section'); manageChat()">Manage Chats</button>
      <button onclick="showSection('settings')">Settings</button>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section">
      <h2>Dashboard</h2>
      <p><strong>Total Payments:</strong> <span id="total-payments">0</span></p>
      <p><strong>Active Subscriptions:</strong> <span id="active-subs">0</span></p>
      <canvas id="analyticsChart" width="300" height="200"></canvas>
    </div>

    <!-- Payments Section -->
    <div id="payments" class="section" style="display: none;">
      <h2>Manage Payments</h2>
      <form id="payment-proof-form">
        <label for="name">Client Name:</label>
        <input type="text" id="name" required />

        <label for="amount">Amount Paid (₦):</label>
        <input type="number" id="amount" required />

        <label for="proof">Upload Proof:</label>
        <input type="file" id="proof" required />

        <button type="submit">Submit Payment</button>
      </form>

      <!-- Upload History Table -->
      <h3 style="margin-top: 30px;">Upload History</h3>
      <table id="upload-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Amount</th>
            <th>File Name</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button onclick="exportUploadHistory()" style="margin-top: 20px;">Export as CSV</button>
    </div>

    <!-- Manage Chat -->
    <div id="chat-section" class="section" style="display: none;">
      <h2>Manage Chats</h2>
      <div id="chat-container"></div>
    </div>

    <!-- Settings -->
    <div id="settings" class="section" style="display: none;">
      <h2>Settings</h2>
      <label for="admin-password">Change Admin Password:</label>
      <input type="password" id="admin-password" placeholder="New password" />
      <button onclick="changePassword()">Update Password</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 NelsonFx Admin Panel. All Rights Reserved.</p>
  </footer>

  <script>
    // Spinner
    window.addEventListener("load", () => {
      const spinner = document.getElementById("spinner");
      if (spinner) spinner.style.display = "none";
    });

    // Animate counters
    function animateValue(id, start, end, duration) {
      const obj = document.getElementById(id);
      let current = start;
      const step = Math.abs(Math.floor(duration / (end - start)));
      const timer = setInterval(() => {
        current += 1;
        obj.textContent = current;
        if (current >= end) clearInterval(timer);
      }, step);
    }

    // Toast notification
    function showToast(message, duration = 3000) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), duration);
    }

    // Dashboard load
    document.addEventListener("DOMContentLoaded", () => {
      animateValue("total-payments", 0, 48, 1000);
      animateValue("active-subs", 0, 19, 1200);

      const ctx = document.getElementById('analyticsChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Monthly Payments',
            data: [5, 10, 8, 15, 20, 25],
            borderColor: '#00ffcc',
            backgroundColor: '#00ffcc44',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { labels: { color: '#fff' } }
          }
        }
      });

      // Form submit
      const form = document.getElementById("payment-proof-form");
      if (form) {
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const name = document.getElementById("name").value;
          const amount = document.getElementById("amount").value;
          const fileInput = document.getElementById("proof");
          const file = fileInput.files[0];

          if (name && amount && file) {
            const table = document.getElementById("upload-table").querySelector("tbody");
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
              <td>${name}</td>
              <td>₦${amount}</td>
              <td>${file.name}</td>
              <td>${new Date().toLocaleString()}</td>`;
            table.appendChild(newRow);
            showToast("Payment proof submitted and recorded.");
            form.reset();
          } else {
            showToast("Please fill in all fields.");
          }
        });
      }
    });

    // Export Upload History
    function exportUploadHistory() {
      const rows = document.querySelectorAll("#upload-table tr");
      let csv = [];

      rows.forEach(row => {
        const cols = row.querySelectorAll("th, td");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv.push(rowData.join(","));
      });

      const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "upload_history.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast("Upload history exported as CSV.");
    }

    // Section toggle
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // Tawk Chat
    function manageChat() {
      document.getElementById("chat-container").innerHTML = `
        <iframe src="https://dashboard.tawk.to"
          width="100%" height="500px"
          style="border:none; border-radius:8px;"></iframe>`;
    }

    // Change password
    function changePassword() {
      const newPass = document.getElementById("admin-password").value;
      if (newPass.length >= 6) {
        showToast("Password updated successfully!");
        document.getElementById("admin-password").value = "";
      } else {
        showToast("Password must be at least 6 characters.");
      }
    }

    // Logout
    function logout() {
      sessionStorage.removeItem("isAdmin");
      showToast("You have been logged out.");
      window.location.href = "admin.html";
    }
  </script>
</body>
</html>
